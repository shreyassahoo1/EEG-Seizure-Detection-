<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINDy Seizure Prediction</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #8b5cf6;
            --background: #0f172a;
            --surface: rgba(30, 41, 59, 0.7);
            --surface-light: rgba(51, 65, 85, 0.5);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--background);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: var(--surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            margin-bottom: 3rem;
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(to right, #818cf8, #e879f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            margin-bottom: 4rem;
            animation: fadeIn 0.8s ease-out;
        }

        .hero h1 {
            font-size: 3.5rem;
            line-height: 1.1;
            margin-bottom: 1.5rem;
            background: linear-gradient(to bottom right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto 2.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.4);
        }

        /* Upload Area */
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .drop-zone {
            position: relative;
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 4rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.02);
            overflow: hidden;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .drop-zone input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .icon-cloud {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Status & Processing */
        .status-container {
            margin-top: 2rem;
            display: none;
            /* hidden by default */
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }

        .step {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            width: 33%;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .step.active {
            opacity: 1;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            background: var(--background);
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            box-shadow: 0 0 15px var(--primary);
        }

        /* Results Section */
        .results-dashboard {
            display: none;
            /* hidden by default */
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
            animation: slideUp 0.6s ease-out;
        }

        .main-chart-card {
            grid-column: 1 / -1;
            min-height: 400px;
        }

        .metric-card {
            text-align: center;
            padding: 2rem;
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            margin: 1rem 0;
            line-height: 1;
        }

        .metric-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .risk-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .risk-high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .risk-low {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .results-dashboard {
                grid-template-columns: 1fr;
            }

            .hero h1 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">üß† SINDy AI</div>
            <button class="btn btn-outline" id="demoBtn" onclick="runDemo()">Try Demo</button>
        </header>

        <!-- Step 1: Upload Hero -->
        <main class="hero" id="uploadSection">
            <h1>Predict Seizures with<br>Math & AI</h1>
            <p>Upload your EEG Data (.edf) to detect early warning signs using Sparse Identification of Nonlinear
                Dynamics.</p>

            <div class="upload-container">
                <div class="drop-zone glass" id="dropZone">
                    <input type="file" id="fileInput" accept=".edf" onchange="handleFileSelect(event)">
                    <div class="icon-cloud">‚òÅÔ∏è</div>
                    <h3 style="margin-bottom: 0.5rem;">Click or Drag & Drop EEG File</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Supports .EDF format (CHB-MIT Standard)</p>
                </div>
            </div>
        </main>

        <!-- Loading / Progress State -->
        <div class="status-container" id="statusSection">
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <span>Preprocessing</span>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <span>Training SINDy</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <span>Predicting</span>
                </div>
            </div>

            <div class="glass-card" style="text-align: center; padding: 3rem;">
                <div id="loader" style="font-size: 2rem; margin-bottom: 1rem;">üîÑ</div>
                <h3 id="statusText">Uploading and filtering signal...</h3>
                <p id="statusDetail" style="color: var(--text-muted); margin-top: 0.5rem;">Applying bandpass filter
                    (0.5-40Hz)</p>
            </div>
        </div>

        <!-- Results Dashboard -->
        <div class="results-dashboard" id="resultsSection">
            <!-- Main Prediction Alert -->
            <div class="glass-card metric-card"
                style="grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-around; flex-wrap: wrap; text-align: left;">
                <div>
                    <div class="risk-badge risk-high" id="riskBadge">HIGH RISK DETECTED</div>
                    <h2 style="font-size: 2rem;">Seizure Prediction</h2>
                    <p style="color: var(--text-muted); max-width: 400px;">
                        The model detected dynamic instability in the signal patterns.
                    </p>
                </div>
                <div style="text-align: center;">
                    <div class="metric-label">Estimated Time to Seizure</div>
                    <div class="metric-value" style="color: var(--danger);" id="timeToSeizure">-- min</div>
                </div>
            </div>

            <!-- Instability Graph -->
            <div class="glass-card main-chart-card">
                <h3 style="margin-bottom: 1.5rem;">Dynamic Instability Score</h3>
                <canvas id="instabilityChart"></canvas>
            </div>

            <!-- Simulation Graph or smaller metrics -->
            <div class="glass-card" style="grid-column: span 1;">
                <h3 style="margin-bottom: 1rem;">Model Details</h3>
                <ul style="list-style: none; color: var(--text-muted); line-height: 2;">
                    <li><strong>Model:</strong> Polynomial SINDy (deg=3)</li>
                    <li><strong>Algorithm:</strong> STLSQ (thresh=0.006)</li>
                    <li><strong>Window Size:</strong> 10 seconds</li>
                    <li><strong>Channels:</strong> <span id="channelCount">--</span></li>
                </ul>
            </div>

            <div class="glass-card" style="grid-column: span 1;">
                <h3 style="margin-bottom: 1rem;">File Stats</h3>
                <div class="metric-value" style="font-size: 2rem;" id="durationStat">--</div>
                <div class="metric-label">Recording Duration</div>
            </div>

            <div class="glass-card" style="grid-column: 1 / -1;">
                <h3 style="margin-bottom: 1rem;">Live Signal Preview (First 5s)</h3>
                <canvas id="signalChart" height="80"></canvas>
            </div>

            <div style="grid-column: 1/-1; text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="window.location.reload()">Analyze Another File</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        // Element Refs
        const uploadSection = document.getElementById('uploadSection');
        const statusSection = document.getElementById('statusSection');
        const resultsSection = document.getElementById('resultsSection');
        const statusText = document.getElementById('statusText');
        const statusDetail = document.getElementById('statusDetail');

        // Charts
        let instabilityChart = null;
        let signalChart = null;

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.edf')) {
                startAnalysis(file);
            } else {
                alert('Please upload a valid .edf file');
            }
        }

        async function runDemo() {
            // Demo mode: Bypass file upload, use demo endpoint
            showStatus();
            try {
                // Step 1: Preprocess (Demo)
                updateStep(1, 'Generating Demo Data...');
                const prepRes = await fetch(`${API_URL}/api/preprocess/demo`, { method: 'POST' });
                if (!prepRes.ok) throw new Error('Demo generation failed');
                const prepData = await prepRes.json();

                renderSignalPreview(prepData.filtered_data.map(d => d[0]).slice(0, 500)); // Just 1 channel for preview
                document.getElementById('channelCount').textContent = prepData.channels;
                document.getElementById('durationStat').textContent = (prepData.samples / 128).toFixed(1) + 's';

                // Continue to Training
                await runTrainingAndPrediction();

            } catch (e) {
                console.error(e);
                alert('Error running demo: ' + e.message);
                window.location.reload();
            }
        }

        async function startAnalysis(file) {
            showStatus();

            try {
                // Step 1: Upload & Preprocess
                updateStep(1, 'Uploading & Processing...', 'Filtering noise and computing derivatives');

                const formData = new FormData();
                formData.append('file', file);

                const prepRes = await fetch(`${API_URL}/api/preprocess`, {
                    method: 'POST',
                    body: formData
                });

                if (!prepRes.ok) throw new Error('Preprocessing failed');
                const prepData = await prepRes.json();

                // Update Stats
                document.getElementById('channelCount').textContent = prepData.channels;
                document.getElementById('durationStat').textContent = (prepData.samples / 128).toFixed(1) + 's';
                renderSignalPreview(prepData.filtered_data.map(d => d[0]).slice(0, 500));

                // Continue
                await runTrainingAndPrediction();

            } catch (e) {
                console.error(e);
                alert('Analysis failed: ' + e.message);
                window.location.reload(); // Simple reset
            }
        }

        async function runTrainingAndPrediction() {
            try {
                // Step 2: Train SINDy
                updateStep(2, 'Training Model...', 'Discovering governing equations (SINDy)');
                const trainRes = await fetch(`${API_URL}/api/sindy/train`, { method: 'POST' });
                if (!trainRes.ok) throw new Error('Training failed');
                // We could show equations here if we wanted to be fancy

                // Step 3: Predict
                updateStep(3, 'Predicting Seizures...', 'Running temporal simulation and instability check');
                const predRes = await fetch(`${API_URL}/api/predict`, { method: 'POST' });
                if (!predRes.ok) throw new Error('Prediction failed');
                const predData = await predRes.json();

                // Show Results
                showResults(predData);

            } catch (e) {
                console.error(e);
                alert('Error in pipeline: ' + e.message);
            }
        }

        function showStatus() {
            uploadSection.style.display = 'none';
            statusSection.style.display = 'block';
            document.querySelector('header').style.display = 'none';
        }

        function updateStep(stepNum, title, detail) {
            // Visual update of steps
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById(`step${i}`);
                if (i === stepNum) el.classList.add('active');
                else if (i < stepNum) el.classList.add('active'); // keep previous active
                // else el.classList.remove('active');
            }
            statusText.textContent = title;
            if (detail) statusDetail.textContent = detail;
        }

        function showResults(data) {
            statusSection.style.display = 'none';
            resultsSection.style.display = 'grid';

            // Risk Badge
            const badge = document.getElementById('riskBadge');
            const timeDisplay = document.getElementById('timeToSeizure');

            if (data.lead_time_minutes) {
                badge.className = 'risk-badge risk-high';
                badge.textContent = '‚ö†Ô∏è SEIZURE RISK DETECTED';
                timeDisplay.textContent = `${data.lead_time_minutes.toFixed(1)} min`;
            } else {
                badge.className = 'risk-badge risk-low';
                badge.textContent = '‚úÖ STABLE BRAIN DYNAMICS';
                timeDisplay.textContent = 'Safe';
                timeDisplay.style.color = 'var(--success)';
            }

            // Render Chart
            renderInstabilityChart(data.instability_scores);
        }

        function renderSignalPreview(dataPoints) {
            const ctx = document.getElementById('signalChart').getContext('2d');
            signalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataPoints.map((_, i) => i),
                    datasets: [{
                        label: 'EEG Signal (Filtered)',
                        data: dataPoints,
                        borderColor: '#aadafa',
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        function renderInstabilityChart(scores) {
            const ctx = document.getElementById('instabilityChart').getContext('2d');

            const labels = scores.map(s => s.window);
            const values = scores.map(s => s.error);
            const threshold = scores[0].threshold; // assumed constant

            instabilityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Instability (MSE)',
                            data: values,
                            borderColor: '#f472b6',
                            backgroundColor: 'rgba(244, 114, 182, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Threshold',
                            data: Array(values.length).fill(threshold),
                            borderColor: '#34d399',
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' },
                            title: { display: true, text: 'Time Windows (10s)', color: '#64748b' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>